name: Publish App Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-zips:
    name: Build ${{ matrix.rid }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            zip_name: Scrubbler-win-x64-${{ github.event.release.tag_name }}.zip
          - os: ubuntu-latest
            rid: linux-x64
            zip_name: Scrubbler-linux-x64-${{ github.event.release.tag_name }}.zip
          - os: macos-latest
            rid: osx-x64
            zip_name: Scrubbler-osx-x64-${{ github.event.release.tag_name }}.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore (host + updater only)
        shell: bash
        working-directory: Scrubbler
        run: |
          dotnet restore Scrubbler.Updater/Scrubbler.Updater.csproj -r ${{ matrix.rid }}
          dotnet restore Scrubbler.Host/Scrubbler.Host.csproj -r ${{ matrix.rid }}

      - name: Test
        run: dotnet test -c Release --verbosity normal
        working-directory: Scrubbler

      - name: Publish updater
        working-directory: Scrubbler
        run: dotnet publish Scrubbler.Updater/Scrubbler.Updater.csproj -c Release -f net10.0 -r ${{ matrix.rid }} --no-restore

      - name: Publish host
        working-directory: Scrubbler
        run: dotnet publish Scrubbler.Host/Scrubbler.Host.csproj -c Release -f net10.0-desktop -r ${{ matrix.rid }} --no-restore

      - name: Assemble portable folder (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $rid = "${{ matrix.rid }}"

          $hostPub = "Scrubbler\Scrubbler.Host\bin\Release\net10.0-desktop\$rid\publish"
          $updPub  = "Scrubbler\Scrubbler.Updater\bin\Release\net10.0\$rid\publish"

          if (!(Test-Path $hostPub)) { throw "Host publish folder not found: $hostPub" }
          if (!(Test-Path $updPub))  { throw "Updater publish folder not found: $updPub" }

          $stage = Join-Path $env:RUNNER_TEMP "scrubbler_stage_$rid"
          if (Test-Path $stage) { Remove-Item $stage -Recurse -Force }
          New-Item -ItemType Directory -Path $stage | Out-Null

          Copy-Item "$hostPub\*" $stage -Recurse -Force

          $updStage = Join-Path $stage "Updater"
          New-Item -ItemType Directory -Path $updStage | Out-Null
          Copy-Item "$updPub\*" $updStage -Recurse -Force

          $outZip = Join-Path $env:RUNNER_TEMP "${{ matrix.zip_name }}"
          if (Test-Path $outZip) { Remove-Item $outZip -Force }

          Compress-Archive -Path (Join-Path $stage "*") -DestinationPath $outZip -Force
          "ZIP_PATH=$outZip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Assemble portable folder (linux/macos)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          rid="${{ matrix.rid }}"

          hostPub="Scrubbler/Scrubbler.Host/bin/Release/net10.0-desktop/${rid}/publish"
          updPub="Scrubbler/Scrubbler.Updater/bin/Release/net10.0/${rid}/publish"

          test -d "$hostPub" || (echo "Host publish folder not found: $hostPub" && exit 1)
          test -d "$updPub"  || (echo "Updater publish folder not found: $updPub" && exit 1)

          stage="$RUNNER_TEMP/scrubbler_stage_${rid}"
          rm -rf "$stage"
          mkdir -p "$stage"

          cp -R "$hostPub"/. "$stage"/

          mkdir -p "$stage/Updater"
          cp -R "$updPub"/. "$stage/Updater"/

          outZip="$RUNNER_TEMP/${{ matrix.zip_name }}"
          rm -f "$outZip"
          (cd "$stage" && zip -r "$outZip" .)

          echo "ZIP_PATH=$outZip" >> "$GITHUB_ENV"

      - name: Upload zip artifact (to workflow)
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.rid }}
          path: ${{ env.ZIP_PATH }}

  upload-release-assets:
    name: Upload release assets + checksums
    runs-on: ubuntu-latest
    needs: build-zips

    steps:
      - name: Download all zips
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Upload assets to GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          tag="${{ github.event.release.tag_name }}"
          gh release upload "$tag" dist/**/*.zip --clobber --repo "${{ github.repository }}"